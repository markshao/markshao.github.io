<!DOCTYPE html><html lang="zh"><head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    <meta name="description" content="&amp;#x6700;&amp;#x8FD1;&amp;#x5F00;&amp;#x542F;&amp;#x4E86;19&amp;#x5E74;&amp;#x7B2C;&amp;#x4E8C;&amp;#x4E2A;&amp;#x91CD;&amp;#x8981;&amp;#x4EFB;&amp;#x52A1;&amp;#xFF0C;Go Lang&amp;#x7684;&amp;#x5B66;&amp;#x4E60;&amp;#xFF0C;&amp;#x5982;&amp;#x679C;&amp;#x4E4B;&amp;#x524D;&amp;#x53EA;&amp;#x662F">
<meta property="og:type" content="article">
<meta property="og:title" content="golang channel ä½¿ç”¨ä¸å½“å¯¼è‡´çš„ deadlock">
<meta property="og:url" content="http://markshao.github.io/2019/03/17/golang-channel-deadlock/index.html">
<meta property="og:site_name" content="å°æ³•@å…µå·¥å‚">
<meta property="og:description" content="&amp;#x6700;&amp;#x8FD1;&amp;#x5F00;&amp;#x542F;&amp;#x4E86;19&amp;#x5E74;&amp;#x7B2C;&amp;#x4E8C;&amp;#x4E2A;&amp;#x91CD;&amp;#x8981;&amp;#x4EFB;&amp;#x52A1;&amp;#xFF0C;Go Lang&amp;#x7684;&amp;#x5B66;&amp;#x4E60;&amp;#xFF0C;&amp;#x5982;&amp;#x679C;&amp;#x4E4B;&amp;#x524D;&amp;#x53EA;&amp;#x662F">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-03-17T13:57:40.000Z">
<meta property="article:modified_time" content="2022-05-18T08:55:05.890Z">
<meta property="article:author" content="å¦çˆ¸çˆ¸">
<meta property="article:tag" content="goroutine">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>golang channel ä½¿ç”¨ä¸å½“å¯¼è‡´çš„ deadlock</title>
    <!-- styles -->
    


    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.2.0"><!-- hexo-inject:begin --><!-- hexo-inject:end --><script>function loadCss(l){var d=document,h=d.head,s=d.createElement('link');s.rel='stylesheet';s.href=l;!function e(f){if (d.body)return f();setTimeout(function(){e(f)})}(function(){h.appendChild(s);});}loadCss('/style.css');</script></head>

<body class="max-width mx-auto px3 ltr">
    
      <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">é¦–é¡µ</a></li><!--
     --><!--
       --><li><a href="/about/">å…³äº</a></li><!--
     --><!--
       --><li><a href="/archives/">å½’æ¡£</a></li><!--
     --><!--
       --><li><a href="/tags/">æ ‡ç­¾</a></li><!--
     --><!--
       --><li><a href="/categories/">åˆ†ç±»</a></li><!--
     --><!--
       --><li><a href="/search/">æœç´¢</a></li><!--
     -->
      </ul>
    </span>
    <br>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="ä¸Šä¸€ç¯‡" href="/2019/03/21/golang-interview-problem-1/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="ä¸‹ä¸€ç¯‡" href="/2019/03/12/distributed-code-analysis/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="è¿”å›é¡¶éƒ¨" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="åˆ†äº«æ–‡ç« " href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">ä¸Šä¸€ç¯‡</span>
      <span id="i-next" class="info" style="display:none;">ä¸‹ä¸€ç¯‡</span>
      <span id="i-top" class="info" style="display:none;">è¿”å›é¡¶éƒ¨</span>
      <span id="i-share" class="info" style="display:none;">åˆ†äº«æ–‡ç« </span>
    </span>
    <br>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://markshao.github.io/2019/03/17/golang-channel-deadlock/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://markshao.github.io/2019/03/17/golang-channel-deadlock/&amp;text=golang channel ä½¿ç”¨ä¸å½“å¯¼è‡´çš„ deadlock"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://markshao.github.io/2019/03/17/golang-channel-deadlock/&amp;title=golang channel ä½¿ç”¨ä¸å½“å¯¼è‡´çš„ deadlock"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://markshao.github.io/2019/03/17/golang-channel-deadlock/&amp;is_video=false&amp;description=golang channel ä½¿ç”¨ä¸å½“å¯¼è‡´çš„ deadlock"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=golang channel ä½¿ç”¨ä¸å½“å¯¼è‡´çš„ deadlock&amp;body=Check out this article: http://markshao.github.io/2019/03/17/golang-channel-deadlock/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://markshao.github.io/2019/03/17/golang-channel-deadlock/&amp;title=golang channel ä½¿ç”¨ä¸å½“å¯¼è‡´çš„ deadlock"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://markshao.github.io/2019/03/17/golang-channel-deadlock/&amp;title=golang channel ä½¿ç”¨ä¸å½“å¯¼è‡´çš„ deadlock"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://markshao.github.io/2019/03/17/golang-channel-deadlock/&amp;title=golang channel ä½¿ç”¨ä¸å½“å¯¼è‡´çš„ deadlock"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://markshao.github.io/2019/03/17/golang-channel-deadlock/&amp;title=golang channel ä½¿ç”¨ä¸å½“å¯¼è‡´çš„ deadlock"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://markshao.github.io/2019/03/17/golang-channel-deadlock/&amp;name=golang channel ä½¿ç”¨ä¸å½“å¯¼è‡´çš„ deadlock&amp;description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://markshao.github.io/2019/03/17/golang-channel-deadlock/&amp;t=golang channel ä½¿ç”¨ä¸å½“å¯¼è‡´çš„ deadlock"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E5%87%BD%E6%95%B0"><span class="toc-number">1.</span> <span class="toc-text">ä¸»å‡½æ•°</span></a></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9D%91"><span class="toc-number"></span> <span class="toc-text">å‘</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#all-goroutines-are-asleep-deadlock"><span class="toc-number">1.</span> <span class="toc-text">all goroutines are asleep - deadlock!</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%88%90%E4%B8%A4%E4%B8%AAgoroutine-%E7%9A%84%E6%A8%A1%E5%BC%8F%E5%B0%B1%E6%B2%A1%E9%97%AE%E9%A2%98%E4%BA%86"><span class="toc-number">2.</span> <span class="toc-text">ä¿®æ”¹æˆä¸¤ä¸ªgoroutine çš„æ¨¡å¼å°±æ²¡é—®é¢˜äº†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E5%8F%88hang%E4%BD%8F%E4%BA%86"><span class="toc-number">3.</span> <span class="toc-text">ç¨‹åºåˆhangä½äº†</span></a></li></ol>
    </li></div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        golang channel ä½¿ç”¨ä¸å½“å¯¼è‡´çš„ deadlock
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
        <span itemprop="name">å¦çˆ¸çˆ¸</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-03-17T13:57:40.000Z" itemprop="datePublished">2019-03-17</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/golang/">golang</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/goroutine/" rel="tag">goroutine</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>æœ€è¿‘å¼€å¯äº†19å¹´ç¬¬äºŒä¸ªé‡è¦ä»»åŠ¡ï¼Œ<code>Go Lang</code>çš„å­¦ä¹ ï¼Œå¦‚æœä¹‹å‰åªæ˜¯å› ä¸ºä¸ªäººçˆ±å¥½çš„è¯ï¼Œç°åœ¨æ˜¯å› ä¸º<code>chaos monkey</code>å¾ˆå¤šéƒ½æ˜¯ç”¨<code>Go Lang</code>å†™çš„ï¼Œä¸å¾—ä¸è¦æŠ“ç´§å®Œæˆè¿™å—çŸ¥è¯†çš„çŸ­æ¿äº†</p>
<p>ä»Šå¤©å°è¯•ç”¨<code>goroutine</code> + <code>channel</code>çš„æ–¹å¼å®ç°ä¸€ä¸ªç®€å•çš„ä¸‹è½½è±†ç“£å›¾ä¹¦å›¾ç‰‡çš„å·¥ä½œï¼Œå¥½åƒæˆ‘ç‰¹åˆ«å–œæ¬¢æ‹¿è±†ç“£æ¥åšå®éªŒï¼Œå“ˆå“ˆï¼Œå¸Œæœ›è±†ç“£çš„åŒå­¦çœ‹åˆ°äº†ä¸è¦ç”Ÿæ°”</p>
<p>##å®ç°é€»è¾‘</p>
<p>ä»£ç é€»è¾‘å…¶å®éå¸¸ç®€å•ï¼Œè¿™ä¸ªè¦æ„Ÿè°¢è±†ç“£çš„éå¸¸ Restful çš„ url , è®©æˆ‘å¯ä»¥ä¸ç”¨é€šè¿‡ parse HTML æ¥è·å–å›¾ç‰‡é“¾æ¥ï¼Œç›´æ¥éå† id å³å¯ ,å›  ä¸º url éƒ½éå¸¸ç®€å• [<a target="_blank" rel="noopener" href="https://img1.doubanio.com/view/subject/l/public/s10000000.jpg]">https://img1.doubanio.com/view/subject/l/public/s10000000.jpg]</a> , è¿™é‡Œå†æ¬¡æ„Ÿè°¢è±†ç“£ï¼Œå“ˆã€‚</p>
<h3 id="ä¸»å‡½æ•°"><a href="#ä¸»å‡½æ•°" class="headerlink" title="ä¸»å‡½æ•°"></a>ä¸»å‡½æ•°</h3><p>main çš„å¤„ç†é€»è¾‘å¦‚ä¸‹</p>
<ol>
<li>åˆ›å»º N ä¸ª go routine</li>
<li>é€šè¿‡ ä¸€ä¸ª task channel ï¼Œæ¥åˆ›å»ºä¸åŒçš„ä¸‹è½½ä»»åŠ¡ï¼Œå®é™…å°±æ˜¯è‡ªå¢çš„æ–¹å¼ç”Ÿæˆæ–°çš„ä¸‹è½½ url</li>
<li>é€šè¿‡ä¸€ä¸ª result çš„channel ï¼Œè·å– go routine çš„ä»»åŠ¡æ‰§è¡Œç»“æœ</li>
<li>ç­‰æ‰€æœ‰ä»»åŠ¡ç»“æŸåï¼Œé€šè¿‡ä¸€ä¸ª</li>
</ol>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">	<span class="comment">//fmt.Println("start crawl the douban site")</span></span><br><span class="line">	init_directory()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// init the main process variables</span></span><br><span class="line">	quit := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, goRoutineSize)</span><br><span class="line">	task := <span class="built_in">make</span>(<span class="keyword">chan</span> ImageTask, goRoutineSize)</span><br><span class="line">	result := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, taskNumber)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// init the goroutine</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; goRoutineSize; i++ {</span><br><span class="line">		spider(task, result, quit)</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">// init the task</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; taskNumber; i++ {</span><br><span class="line">		taskId := taskOffsize + i</span><br><span class="line">		url := fmt.Sprintf(<span class="string">"https://img1.doubanio.com/view/subject/l/public/s%d.jpg"</span>, taskId)</span><br><span class="line">		task &lt;- ImageTask{url: url, tid: taskId}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">// wait all the goroutine done</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; taskNumber; i++ {</span><br><span class="line">		&lt;-result</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; goRoutineSize; i++ {</span><br><span class="line">		quit &lt;- <span class="number">1</span></span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="built_in">close</span>(quit)</span><br><span class="line">	<span class="built_in">close</span>(result)</span><br><span class="line">	<span class="built_in">close</span>(task)</span><br><span class="line">	fmt.Println(<span class="string">"finish the task"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>çœ‹ä¼¼ç®€å•çš„ä»£ç ï¼Œå®é™…ä¸Šåœ¨<code>channel</code>ä¸ŠğŸ‘äº†å¾ˆå¤šæ¬¡å‘</p>
<h2 id="å‘"><a href="#å‘" class="headerlink" title="å‘"></a>å‘</h2><h3 id="all-goroutines-are-asleep-deadlock"><a href="#all-goroutines-are-asleep-deadlock" class="headerlink" title="all goroutines are asleep - deadlock!"></a>all goroutines are asleep - deadlock!</h3><p>ä¸€å¼€å§‹æ²¡æœ‰ç”¨å¸¦buffer çš„channel ï¼Œå°±å‘ç”Ÿäº†<code>all goroutines are asleep - deadlock!</code>, æ„Ÿè§‰å¾ˆå¥‡æ€ªï¼Œgoogle äº†åŠè¾¹å¤©å‘ç°è¿™ä¸ªæ˜¯ä¸€ä¸ªå…¸å‹çš„<code>channel</code>ç”¨æ³•é”™è¯¯ï¼Œå°è¯•åšä¸€ä¸ªéå¸¸ç®€å•çš„å®éªŒï¼Œçœ‹èµ·æ¥æ˜¯ä¸ä¼šæœ‰ä»»ä½•é—®é¢˜çš„ä»£ç </p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">	fmt.Println(<span class="string">"start main2"</span>)</span><br><span class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line">	ch &lt;- <span class="number">1</span></span><br><span class="line">	fmt.Println(&lt;-ch)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p>è¿è¡Œçš„ç»“æœè¿˜æ˜¯è€æ ·å­</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">fatal <span class="type">error</span>: all goroutines are asleep - deadlock!</span><br><span class="line"></span><br><span class="line">goroutine <span class="number">1</span> [<span class="keyword">chan</span> send]:</span><br><span class="line">main.main()</span><br><span class="line">	/Users/ylshao/code/lab/douban_spider/src/github.com/markshao/main2.<span class="keyword">go</span>:<span class="number">9</span> +<span class="number">0xbc</span></span><br></pre></td></tr></tbody></table></figure>

<p>æœ€åå‘ç°[è¿™ç¯‡æ–‡ç« ][<a target="_blank" rel="noopener" href="https://my.oschina.net/u/157514/blog/149192]%E8%A7%A3%E9%87%8A%E7%9A%84%E6%AF%94%E8%BE%83%E6%B8%85,%E8%BF%99%E9%87%8C%E7%9A%84%E9%97%AE%E9%A2%98%E5%B0%B1%E6%98%AF%E5%A4%84%E5%9C%A8%E6%B2%A1%E6%9C%89buffer">https://my.oschina.net/u/157514/blog/149192]è§£é‡Šçš„æ¯”è¾ƒæ¸…,è¿™é‡Œçš„é—®é¢˜å°±æ˜¯å¤„åœ¨æ²¡æœ‰buffer</a> çš„channel ä¸Šï¼Œä¸Šé¢è¿™ä¸ªä¾‹å­é‡Œï¼Œæ²¡æœ‰buffer çš„channel å½“ä½ å†™å…¥çš„æ—¶å€™ï¼Œå®ƒå°±ä¼šblockï¼Œç›´åˆ°æœ‰å¦å¤–ä¸€ä¸ªçº¿ç¨‹æ‹¿èµ°è¿™ä¸ªitemï¼Œç”±äºæˆ‘ä»¬æ²¡æœ‰ç”¨goroutineï¼Œç­‰äºè¯´master çš„goroutine å°±è¢«æ•´ä¸ªé”ä½äº†ï¼Œä¹Ÿå°±ä¸ºä»€ä¹ˆgo runtime ä¼šæŠ¥ deadlockçš„é—®é¢˜ï¼Œ</p>
<h3 id="ä¿®æ”¹æˆä¸¤ä¸ªgoroutine-çš„æ¨¡å¼å°±æ²¡é—®é¢˜äº†"><a href="#ä¿®æ”¹æˆä¸¤ä¸ªgoroutine-çš„æ¨¡å¼å°±æ²¡é—®é¢˜äº†" class="headerlink" title="ä¿®æ”¹æˆä¸¤ä¸ªgoroutine çš„æ¨¡å¼å°±æ²¡é—®é¢˜äº†"></a>ä¿®æ”¹æˆä¸¤ä¸ªgoroutine çš„æ¨¡å¼å°±æ²¡é—®é¢˜äº†</h3><figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> {</span><br><span class="line">	fmt.Println(<span class="string">"start main2"</span>)</span><br><span class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">		ch &lt;- <span class="number">1</span></span><br><span class="line">	}()</span><br><span class="line"></span><br><span class="line">	fmt.Println(&lt;-ch)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è¾“å‡ºç»“æœ</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">start main2</span><br><span class="line">1</span><br></pre></td></tr></tbody></table></figure>



<h3 id="ç¨‹åºåˆhangä½äº†"><a href="#ç¨‹åºåˆhangä½äº†" class="headerlink" title="ç¨‹åºåˆhangä½äº†"></a>ç¨‹åºåˆhangä½äº†</h3><p>ä¸Šé¢ä¸€ä¸ªé—®é¢˜è§£äº†ä»¥åï¼Œæˆ‘æŠŠchannelæ”¹æˆäº†è¿™æ ·</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// goRoutineSize = 10</span></span><br><span class="line"><span class="comment">// taskNumber = 50</span></span><br><span class="line">quit := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, goRoutineSize) </span><br><span class="line">task := <span class="built_in">make</span>(<span class="keyword">chan</span> ImageTask, goRoutineSize)</span><br><span class="line">result := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, goRoutineSize)</span><br></pre></td></tr></tbody></table></figure>

<p>è¿™é‡Œ<code>goRoutineSize</code>è¡¨ç¤ºåˆ›å»ºçš„åç¨‹æ•°é‡ï¼Œå¦å¤–è¿˜æœ‰ä¸€ä¸ª<code>taskNumber</code>è¡¨ç¤ºä»»åŠ¡æ•°é‡ï¼Œä½†æ˜¯ä¸€è¿è¡Œåˆhangä½äº†ï¼Œæˆ‘æ€€ç–‘è¿˜æ˜¯hang åœ¨äº†channel ä¸Šé¢ï¼Œå…ˆçœ‹ä¸€ä¸‹ worker çš„<code>go routine</code>çš„é€»è¾‘</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">spider</span><span class="params">(task <span class="keyword">chan</span> ImageTask, result, quit <span class="keyword">chan</span> <span class="type">int</span>)</span></span> {</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> {</span><br><span class="line">		<span class="keyword">for</span> {</span><br><span class="line">			<span class="keyword">select</span> {</span><br><span class="line">			<span class="keyword">case</span> t := &lt;-task:</span><br><span class="line">				downloadImage(t)</span><br><span class="line">				result &lt;- <span class="number">1</span></span><br><span class="line">				fmt.Printf(<span class="string">"finish downloa the task %v \n"</span>, t)</span><br><span class="line">			<span class="keyword">case</span> &lt;-quit:</span><br><span class="line">				fmt.Println(<span class="string">"finish the go routine"</span>)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				time.Sleep(<span class="number">50</span> * time.Microsecond)</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">	}()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æ€€ç–‘æ˜¯<code>result &lt;- 1 </code>è¿™é‡Œblockäº†ï¼Œå°è¯•åˆ†è§£ä¸€ä¸‹ç¨‹åºçš„è¿è¡Œ</p>
<ol>
<li>å…ˆåˆ›å»º10 ä¸ª <code>go routine</code>, task channel çš„ buffer å°±æ˜¯ 10</li>
<li>ç„¶åmaster goroutine æœ task é‡Œé¢å†™å…¥ 50 ä¸ªtaskï¼Œå®é™…æ˜¯è¦ç­‰ worker åˆ†æ‰¹æ‹¿èµ°ä»»åŠ¡æ‰èƒ½å†å†™å…¥çš„</li>
<li><strong>worker åšå®Œä»»åŠ¡åï¼Œä¼šå†™å…¥ result ï¼Œä½†æ˜¯è¿™é‡Œ result çš„buffer æ˜¯ 10ï¼Œæ‰€ä»¥ä¸€æ—¦å†™æ»¡ï¼Œworker å°±ä¼šblock åœ¨ <code>result &lt;- 1</code> ä¸Šï¼Œè¿™æ ·ä»–ä»¬å°±ä¸ä¼šå»è·å–<code>task</code> , ç„¶åå¤–éƒ¨å°±ä¼šblock åœ¨ <code>task &lt;- â€¦</code>ä¸Šï¼Œæ•´ä½“å°±hangä½äº†</strong></li>
</ol>
<p>ä¿®æ”¹çš„æ–¹å¼å°±å¾ˆç®€å•äº†,result çš„ buffer size æ”¹æˆ taskNumber å°±å¥½äº†</p>
<figure class="highlight go"><table><tbody><tr><td class="code"><pre><span class="line">quit := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, goRoutineSize)</span><br><span class="line">	task := <span class="built_in">make</span>(<span class="keyword">chan</span> ImageTask, goRoutineSize)</span><br><span class="line">	result := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, taskNumber)</span><br></pre></td></tr></tbody></table></figure>



<p>æ‰€ä»¥è¯´è™½ç„¶éƒ½è¯´go çš„å¹¶å‘å¥½å†™ï¼Œä½†æ˜¯è¦æŠŠchannel ç†è§£å¥½ï¼Œç”¨å¥½ï¼ŒçœŸæ˜¯ä»»é‡é“è¿œ </p>
<p>[<a target="_blank" rel="noopener" href="https://my.oschina.net/u/157514/blog/149192%EF%BC%89]">https://my.oschina.net/u/157514/blog/149192ï¼‰]</a>: </p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>åŠ è½½è¯„è®ºéœ€è¦åœ¨æµè§ˆå™¨å¯ç”¨ JavaScript è„šæœ¬æ”¯æŒã€‚</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">é¦–é¡µ</a></li>
         
          <li><a href="/about/">å…³äº</a></li>
         
          <li><a href="/archives/">å½’æ¡£</a></li>
         
          <li><a href="/tags/">æ ‡ç­¾</a></li>
         
          <li><a href="/categories/">åˆ†ç±»</a></li>
         
          <li><a href="/search/">æœç´¢</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E5%87%BD%E6%95%B0"><span class="toc-number">1.</span> <span class="toc-text">ä¸»å‡½æ•°</span></a></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9D%91"><span class="toc-number"></span> <span class="toc-text">å‘</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#all-goroutines-are-asleep-deadlock"><span class="toc-number">1.</span> <span class="toc-text">all goroutines are asleep - deadlock!</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%88%90%E4%B8%A4%E4%B8%AAgoroutine-%E7%9A%84%E6%A8%A1%E5%BC%8F%E5%B0%B1%E6%B2%A1%E9%97%AE%E9%A2%98%E4%BA%86"><span class="toc-number">2.</span> <span class="toc-text">ä¿®æ”¹æˆä¸¤ä¸ªgoroutine çš„æ¨¡å¼å°±æ²¡é—®é¢˜äº†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E5%8F%88hang%E4%BD%8F%E4%BA%86"><span class="toc-number">3.</span> <span class="toc-text">ç¨‹åºåˆhangä½äº†</span></a></li></ol>
    </li></div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://markshao.github.io/2019/03/17/golang-channel-deadlock/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://markshao.github.io/2019/03/17/golang-channel-deadlock/&amp;text=golang channel ä½¿ç”¨ä¸å½“å¯¼è‡´çš„ deadlock"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://markshao.github.io/2019/03/17/golang-channel-deadlock/&amp;title=golang channel ä½¿ç”¨ä¸å½“å¯¼è‡´çš„ deadlock"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://markshao.github.io/2019/03/17/golang-channel-deadlock/&amp;is_video=false&amp;description=golang channel ä½¿ç”¨ä¸å½“å¯¼è‡´çš„ deadlock"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=golang channel ä½¿ç”¨ä¸å½“å¯¼è‡´çš„ deadlock&amp;body=Check out this article: http://markshao.github.io/2019/03/17/golang-channel-deadlock/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://markshao.github.io/2019/03/17/golang-channel-deadlock/&amp;title=golang channel ä½¿ç”¨ä¸å½“å¯¼è‡´çš„ deadlock"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://markshao.github.io/2019/03/17/golang-channel-deadlock/&amp;title=golang channel ä½¿ç”¨ä¸å½“å¯¼è‡´çš„ deadlock"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://markshao.github.io/2019/03/17/golang-channel-deadlock/&amp;title=golang channel ä½¿ç”¨ä¸å½“å¯¼è‡´çš„ deadlock"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://markshao.github.io/2019/03/17/golang-channel-deadlock/&amp;title=golang channel ä½¿ç”¨ä¸å½“å¯¼è‡´çš„ deadlock"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://markshao.github.io/2019/03/17/golang-channel-deadlock/&amp;name=golang channel ä½¿ç”¨ä¸å½“å¯¼è‡´çš„ deadlock&amp;description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://markshao.github.io/2019/03/17/golang-channel-deadlock/&amp;t=golang channel ä½¿ç”¨ä¸å½“å¯¼è‡´çš„ deadlock"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> èœå•</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> ç›®å½•</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> åˆ†äº«</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> è¿”å›é¡¶éƒ¨</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright Â©
    
    
    2013-2022
    å¦çˆ¸çˆ¸
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">é¦–é¡µ</a></li><!--
     --><!--
       --><li><a href="/about/">å…³äº</a></li><!--
     --><!--
       --><li><a href="/archives/">å½’æ¡£</a></li><!--
     --><!--
       --><li><a href="/tags/">æ ‡ç­¾</a></li><!--
     --><!--
       --><li><a href="/categories/">åˆ†ç±»</a></li><!--
     --><!--
       --><li><a href="/search/">æœç´¢</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'">


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"å¤åˆ¶åˆ°ç²˜è´´æ¿!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "å¤åˆ¶æˆåŠŸ!");
      e.clearSelection();
    })
  })
  </script>




<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

  

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

    

<!-- utterances Comments --><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->




<script type="text/javascript" src="{{ src }}">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->



<script type="text/javascript" src="/bundle.js"></script><script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?816b888dc28ee1eeda0dc5b6b8624c6c";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        ;

        var disqus_shortname = 'zaibaba';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    ;

  MathJax.Hub.Config({{ JSON.stringify(config) }});
;

  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script></body></html>